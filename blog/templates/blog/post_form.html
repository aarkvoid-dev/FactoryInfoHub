{% extends 'base.html' %}
{% load static %}

{% block title %}Create Blog Post - FactoryInfoHub{% endblock %}

{% block content %}
<section class="hero">
  <div class="hero__bg">
    <img src="{% static 'img/hero/1.png' %}" alt="image">
    <img src="{% static 'img/hero/1/shape.svg' %}" alt="image">
  </div>
  <div class="container">
    <div class="row justify-center">
      <div class="col-xl-12">
        <div class="hero__content ">
          <h1 class="hero__title text-light-1 ">Create your own blog</h1>
          <p class="hero__text text-light-1 ">Create blog to show your Ideas</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="layout-pt-lg layout-pb-lg">
  <div class="container">
    <div class="row justify-center">
      <div class="col-xl-8 col-lg-10 col-md-12">
        <div class="text-center mb-60 md:mb-30">
          <h1 class="text-30">Create Blog Post</h1>
          <div class="text-18 fw-500 mt-20 md:mt-15">Share your insights and experiences with our community</div>
        </div>

        <!-- Colored div to make navbar visible -->
        <div style="height: 80px; background: linear-gradient(135deg, #EB662B 0%, #FF8C42 100%);"></div>
        
        <div class="contactForm border-1 rounded-12 px-60 py-60 md:px-25 md:py-30">
          {% if messages %}
            <div class="alert alert-info mb-30">
              {% for message in messages %}
                <div class="text-14">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
          
          {% if form.non_field_errors %}
            <div class="alert alert-danger mb-30">
              {% for error in form.non_field_errors %}
                <div class="text-14">{{ error }}</div>
              {% endfor %}
            </div>
          {% endif %}
          
          <form method="post" enctype="multipart/form-data" id="blog-form">
            {% csrf_token %}
            
            <div class="row y-gap-30">
              <div class="col-md-12">
                <div class="form-input">
                  {{ form.title }}
                  <label class="lh-1 text-16 text-light-1">Blog Title</label>
                  {% if form.title.errors %}
                    <div class="text-danger mt-10">{{ form.title.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-input">
                  {{ form.category }}
                  <label class="lh-1 text-16 text-light-1">Category</label>
                  {% if form.category.errors %}
                    <div class="text-danger mt-10">{{ form.category.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-input">
                  {{ form.subcategory }}
                  <label class="lh-1 text-16 text-light-1">Sub-Category</label>
                  {% if form.subcategory.errors %}
                    <div class="text-danger mt-10">{{ form.subcategory.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-input">
                  {{ form.country }}
                  <label class="lh-1 text-16 text-light-1">Country</label>
                  {% if form.country.errors %}
                    <div class="text-danger mt-10">{{ form.country.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-input">
                  {{ form.state }}
                  <label class="lh-1 text-16 text-light-1">State/Province</label>
                  {% if form.state.errors %}
                    <div class="text-danger mt-10">{{ form.state.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-input">
                  {{ form.city }}
                  <label class="lh-1 text-16 text-light-1">City</label>
                  {% if form.city.errors %}
                    <div class="text-danger mt-10">{{ form.city.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-input">
                  {{ form.district }}
                  <label class="lh-1 text-16 text-light-1">District</label>
                  {% if form.district.errors %}
                    <div class="text-danger mt-10">{{ form.district.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-12">
                <div class="form-input">
                  {{ form.region }}
                  <label class="lh-1 text-16 text-light-1">Region</label>
                  {% if form.region.errors %}
                    <div class="text-danger mt-10">{{ form.region.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-12">
                <div class="form-input">
                  {{ form.excerpt }}
                  <label class="lh-1 text-16 text-light-1">Excerpt</label>
                  <div class="text-12 text-light-1 mt-5">A brief summary of your blog post (150-200 characters)</div>
                  {% if form.excerpt.errors %}
                    <div class="text-danger mt-10">{{ form.excerpt.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-12">
                <div class="form-input">
                  {{ form.content }}
                  <label class="lh-1 text-16 text-light-1">Content</label>
                  {% if form.content.errors %}
                    <div class="text-danger mt-10">{{ form.content.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-12">
                <div class="form-input">
                  <label class="lh-1 text-16 text-light-1 mb-15">Upload Images</label>
                  {{ form.images }}
                  <div class="text-12 text-light-1 mt-5">Select multiple images to upload. The first image will be set as featured.</div>
                  
                  <!-- Preview area for selected images -->
                  <div id="image-preview" class="mt-20"></div>
                </div>
              </div>

              <div class="col-md-12">
                <div class="d-flex items-center">
                  <div class="form-checkbox">
                    {{ form.is_published }}
                    <div class="form-checkbox__mark">
                      <div class="form-checkbox__icon">
                        <svg width="10" height="8" viewBox="0 0 10 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M9.29082 0.971021C9.01235 0.692189 8.56018 0.692365 8.28134 0.971021L3.73802 5.51452L1.71871 3.49523C1.43988 3.21639 0.987896 3.21639 0.709063 3.49523C0.430231 3.77406 0.430231 4.22604 0.709063 4.50487L3.23309 7.0289C3.37242 7.16823 3.55512 7.23807 3.73783 7.23807C3.92054 7.23807 4.10341 7.16841 4.24274 7.0289L9.29082 1.98065C9.56965 1.70201 9.56965 1.24984 9.29082 0.971021Z" fill="white" />
                        </svg>
                      </div>
                    </div>
                  </div>
                  <div class="lh-16 ml-15">{{ form.is_published.label }}</div>
                  {% if form.is_published.errors %}
                    <div class="text-danger mt-10">{{ form.is_published.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row y-gap-20 pt-30">
              <div class="col-md-6">
                <button type="submit" class="button -md -dark-1 bg-accent-1 text-white w-100">
                  Create Post
                  <i class="icon-arrow-top-right text-16 ml-10"></i>
                </button>
              </div>
              <div class="col-md-6">
                <a href="{% url 'blog:post_list' %}" class="button -md -outline-dark-1 bg-light-1 text-dark-1 w-100">
                  Cancel
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}
{% block extra_css %}
<style>
  /* Enhanced form styling to match website design */
  .contactForm {
    background: #fff;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  }

  .form-input {
    position: relative;
    margin-bottom: 20px;
  }

  .form-input input,
  .form-input select,
  .form-input textarea {
    width: 100%;
    padding: 15px 20px;
    border: 1px solid #EAEAEA;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: #fff;
  }

  .form-input input:focus,
  .form-input select:focus,
  .form-input textarea:focus {
    outline: none;
    border-color: #EB662B;
    box-shadow: 0 0 0 3px rgba(235, 102, 43, 0.1);
  }

  .form-input textarea {
    min-height: 150px;
    resize: vertical;
  }

  .form-input label {
    position: absolute;
    left: 20px;
    top: 15px;
    background: #fff;
    padding: 0 5px;
    color: #999;
    font-size: 14px;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1;
  }

  .form-input input:focus + label,
  .form-input select:focus + label,
  .form-input textarea:focus + label,
  .form-input input:not(:placeholder-shown) + label,
  .form-input textarea:not(:placeholder-shown) + label {
    top: -10px;
    left: 15px;
    font-size: 12px;
    color: #EB662B;
    background: #fff;
  }

  .form-input input:not(:placeholder-shown) + label {
    top: -10px;
    left: 15px;
    font-size: 12px;
    color: #EB662B;
    background: #fff;
  }

  .form-input textarea:not(:placeholder-shown) + label {
    top: -10px;
    left: 15px;
    font-size: 12px;
    color: #EB662B;
    background: #fff;
  }

  .form-control-file {
    border: 1px solid #EAEAEA;
    border-radius: 12px;
    padding: 10px;
    background: #fff;
    width: 100%;
  }

  .form-checkbox {
    display: flex;
    align-items: center;
  }

  .form-checkbox input {
    width: auto;
    margin-right: 10px;
  }

  .button {
    border-radius: 12px;
    padding: 15px 30px;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }

  .button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }

  .text-danger {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
  }

  /* Image preview styling */
  #image-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
  }

  .image-preview-item {
    position: relative;
    width: 120px;
    height: 120px;
  }

  .image-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #EAEAEA;
  }

  @media (max-width: 768px) {
    .contactForm {
      padding: 25px;
    }
    
    .form-input input,
    .form-input select,
    .form-input textarea {
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }

  .hero {
    position: relative;
    overflow: hidden;
}

.hero__bg {
    position: absolute;
    inset: 0;
    z-index: 1;
}

.hero__bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.hero__content {
    position: relative;
    z-index: 2;
    color: white;
    text-align: center;
    padding: 120px 20px;
}

/* optional dark overlay for readability */
.hero::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 1;
}

</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('images-input');
    const previewContainer = document.getElementById('image-preview');

    // Image preview functionality
    fileInput.addEventListener('change', function(e) {
        previewContainer.innerHTML = '';
        
        if (this.files && this.files.length > 0) {
            const files = Array.from(this.files);
            
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview-item';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        `;
                        previewContainer.appendChild(previewDiv);
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        }
    });

    // Add placeholder text to textarea
    const contentField = document.querySelector('textarea[name="content"]');
    if (contentField) {
        contentField.setAttribute('placeholder', 'Write your blog post content here...');
    }

    // Add placeholder text to excerpt field
    const excerptField = document.querySelector('input[name="excerpt"]');
    if (excerptField) {
        excerptField.setAttribute('placeholder', 'Brief summary of your blog post...');
    }

    // Dynamic cascading functionality for categories and locations
    const categorySelect = document.getElementById('id_category');
    const subcategorySelect = document.getElementById('id_subcategory');
    const countrySelect = document.getElementById('id_country');
    const stateSelect = document.getElementById('id_state');
    const citySelect = document.getElementById('id_city');
    const districtSelect = document.getElementById('id_district');
    const regionSelect = document.getElementById('id_region');

    // Category cascading using existing category app AJAX endpoint
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            const categoryId = this.value;
            if (categoryId) {
                fetch(`/categories/ajax/load-subcategories/${categoryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        subcategorySelect.innerHTML = '<option value="">Select Sub-Category</option>';
                        data.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.id;
                            option.textContent = subcategory.name;
                            subcategorySelect.appendChild(option);
                        });
                        subcategorySelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error fetching subcategories:', error);
                        subcategorySelect.innerHTML = '<option value="">Error loading subcategories</option>';
                        subcategorySelect.disabled = true;
                    });
            } else {
                subcategorySelect.innerHTML = '<option value="">Select Sub-Category</option>';
                subcategorySelect.disabled = true;
            }
        });
    }

    // Country cascading using existing location app AJAX endpoint
    if (countrySelect) {
        countrySelect.addEventListener('change', function() {
            const countryId = this.value;
            if (countryId) {
                fetch(`/location/ajax/states-by-country/${countryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        stateSelect.innerHTML = '<option value="">Select State</option>';
                        data.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state.id;
                            option.textContent = state.name;
                            stateSelect.appendChild(option);
                        });
                        stateSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error fetching states:', error);
                        stateSelect.innerHTML = '<option value="">Error loading states</option>';
                        stateSelect.disabled = true;
                    });
            } else {
                stateSelect.innerHTML = '<option value="">Select State</option>';
                stateSelect.disabled = true;
            }
        });
    }

    // State cascading using existing location app AJAX endpoint
    if (stateSelect) {
        stateSelect.addEventListener('change', function() {
            const stateId = this.value;
            if (stateId) {
                fetch(`/location/ajax/cities-by-state/${stateId}/`)
                    .then(response => response.json())
                    .then(data => {
                        citySelect.innerHTML = '<option value="">Select City</option>';
                        data.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.id;
                            option.textContent = city.name;
                            citySelect.appendChild(option);
                        });
                        citySelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error fetching cities:', error);
                        citySelect.innerHTML = '<option value="">Error loading cities</option>';
                        citySelect.disabled = true;
                    });
            } else {
                citySelect.innerHTML = '<option value="">Select City</option>';
                citySelect.disabled = true;
            }
        });
    }

    // City cascading using existing location app AJAX endpoint
    if (citySelect) {
        citySelect.addEventListener('change', function() {
            const cityId = this.value;
            if (cityId) {
                fetch(`/location/ajax/districts-by-city/${cityId}/`)
                    .then(response => response.json())
                    .then(data => {
                        districtSelect.innerHTML = '<option value="">Select District</option>';
                        data.forEach(district => {
                            const option = document.createElement('option');
                            option.value = district.id;
                            option.textContent = district.name;
                            districtSelect.appendChild(option);
                        });
                        districtSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error fetching districts:', error);
                        districtSelect.innerHTML = '<option value="">Error loading districts</option>';
                        districtSelect.disabled = true;
                    });
            } else {
                districtSelect.innerHTML = '<option value="">Select District</option>';
                districtSelect.disabled = true;
            }
        });
    }

    // District cascading using existing location app AJAX endpoint
    if (districtSelect) {
        districtSelect.addEventListener('change', function() {
            const districtId = this.value;
            if (districtId) {
                fetch(`/location/ajax/regions-by-district/${districtId}/`)
                    .then(response => response.json())
                    .then(data => {
                        regionSelect.innerHTML = '<option value="">Select Region</option>';
                        data.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.id;
                            option.textContent = region.name;
                            regionSelect.appendChild(option);
                        });
                        regionSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error fetching regions:', error);
                        regionSelect.innerHTML = '<option value="">Error loading regions</option>';
                        regionSelect.disabled = true;
                    });
            } else {
                regionSelect.innerHTML = '<option value="">Select Region</option>';
                regionSelect.disabled = true;
            }
        });
    }

    // Initialize cascading based on existing values (for edit mode)
    if (categorySelect && categorySelect.value) {
        // Set the subcategory value if it exists
        const subcategoryValue = document.getElementById('id_subcategory').value;
        categorySelect.dispatchEvent(new Event('change'));
        
        // After the subcategories are loaded, set the selected value
        setTimeout(() => {
            if (subcategoryValue) {
                document.getElementById('id_subcategory').value = subcategoryValue;
            }
        }, 500);
    }
    if (countrySelect && countrySelect.value) {
        // Set the state value if it exists
        const stateValue = document.getElementById('id_state').value;
        countrySelect.dispatchEvent(new Event('change'));
        
        // After the states are loaded, set the selected value
        setTimeout(() => {
            if (stateValue) {
                document.getElementById('id_state').value = stateValue;
            }
        }, 500);
    }
    if (stateSelect && stateSelect.value) {
        // Set the city value if it exists
        const cityValue = document.getElementById('id_city').value;
        stateSelect.dispatchEvent(new Event('change'));
        
        // After the cities are loaded, set the selected value
        setTimeout(() => {
            if (cityValue) {
                document.getElementById('id_city').value = cityValue;
            }
        }, 500);
    }
    if (citySelect && citySelect.value) {
        // Set the district value if it exists
        const districtValue = document.getElementById('id_district').value;
        citySelect.dispatchEvent(new Event('change'));
        
        // After the districts are loaded, set the selected value
        setTimeout(() => {
            if (districtValue) {
                document.getElementById('id_district').value = districtValue;
            }
        }, 500);
    }
    if (districtSelect && districtSelect.value) {
        // Set the region value if it exists
        const regionValue = document.getElementById('id_region').value;
        districtSelect.dispatchEvent(new Event('change'));
        
        // After the regions are loaded, set the selected value
        setTimeout(() => {
            if (regionValue) {
                document.getElementById('id_region').value = regionValue;
            }
        }, 500);
    }
});
</script>
{% endblock %}