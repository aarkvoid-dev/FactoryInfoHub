{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Blog Post - FactoryInfoHub{% endblock %}

{% block content %}

<div class="row">
    <div class="col-12">
        <div class="featured-hero-card">
            <div class="hero-overlay"></div>
            <img src="{% static 'img/hero/1.png' %}" alt="Featured" class="hero-img" id="hero-preview">
            <div class="hero-content">
                <span class="badge-featured">EDIT POST</span>
                <h1 class="text-white text-40 md:text-30 fw-700 mt-10" id="title-live-preview">{{ object.title }}</h1>
                <div class="text-white opacity-70">Author: {{ object.author.get_full_name|default:object.author.username }}</div>
            </div>
        </div>
    </div>
</div>

<section class="layout-pt-md layout-pb-xl">
    <div class="container">
        <form method="post" enctype="multipart/form-data" id="blog-form">
            {% csrf_token %}
            
            <div class="row y-gap-30 justify-center">
                <div class="col-lg-8">
                    
                    <div class="form-input mb-20">
                        {{ form.title }}
                        <label class="lh-1 text-16">Post Title</label>
                    </div>

                    <div class="d-flex flex-wrap align-items-center mb-30 gap-2">
                        <div class="form-group-custom">
                            {{ form.category }}
                        </div>
                        <div class="form-group-custom">
                            {{ form.subcategory }}
                        </div>
                    </div>

                    <div class="post-content mt-20">
                        <div class="form-input">
                            {{ form.content }}
                            <label class="lh-1 text-16">Article Content</label>
                        </div>
                    </div>

                    <h4 class="text-18 fw-600 mb-20">Post Settings</h4>
                        
                    <div class="form-input mb-20">
                        {{ form.excerpt }}
                        <label class="lh-1 text-14">Short Summary</label>
                    </div>

                    <div class="line mb-20"></div>

                    <h5 class="text-18 fw-600 mb-20">Target Location</h5>
                    
                    <div class="d-flex flex-wrap align-items-center mb-30 gap-2">
                        <div class="form-group-custom">
                            {{ form.country }}
                        </div>
                        <div class="form-group-custom">
                            {{ form.state }}
                        </div>
                    </div>
                    <div class="d-flex flex-wrap align-items-center mb-30 gap-2">
                        <div class="form-group-custom">
                            {{ form.city }}
                        </div>
                        <div class="form-group-custom">
                            {{ form.district }}
                        </div>
                    </div>
                    <div class="d-flex flex-wrap align-items-center mb-30 gap-2">
                        <div class="form-group-custom">
                            {{ form.region }}
                        </div>
                    </div>
                       
                    <div class="line mt-20 mb-20"></div>

                    <h5 class="text-18 fw-600 mb-20">Related Factories</h5>
                    
                    <div class="form-group mb-30">
                        <div class="text-muted mb-15">Select factories that are related to this blog post:</div>
                        
                        <!-- Search Bar -->
                        <div class="mb-15">
                            <div class="form-input">
                                <input type="text" id="factory-search" placeholder="Search factories by name..." class="form-control">
                                <label class="lh-1 text-14">Search Factories</label>
                            </div>
                        </div>
                        
                        <!-- Sideways Scrollable Factory Cards -->
                        <div class="factory-cards-container" style="border: 1px solid #EAEAEA; border-radius: 8px; padding: 15px; background: #fafafa; margin-bottom: 15px;">
                            <div id="factory-cards" class="factory-cards-wrapper" style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: thin;">
                                {% for factory in factories %}
                                    <div class="factory-card-item" data-name="{{ factory.name|lower }}" style="min-width: 200px; flex: 0 0 200px;">
                                        <div class="card h-100 border-0 shadow-sm" style="border-radius: 8px; overflow: hidden;">
                                            <div class="position-relative">
                                                {% if factory.get_primary_image %}
                                                    <img src="{{ factory.get_primary_image }}" alt="{{ factory.name }}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                                {% else %}
                                                    <div class="bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                                        <i class="icon-building text-40 text-muted"></i>
                                                    </div>
                                                {% endif %}
                                                <div class="position-absolute top-0 start-0 m-2">
                                                    <input type="checkbox" name="related_factories" value="{{ factory.id }}" id="factory_{{ factory.id }}" class="form-check-input" style="width: 18px; height: 18px; accent-color: #EB662B;"
                                                        {% if factory in object.related_factories.all %}checked{% endif %}>
                                                </div>
                                            </div>
                                            <div class="card-body p-3">
                                                <h6 class="card-title text-dark mb-1" style="font-size: 14px; font-weight: 600;">{{ factory.name }}</h6>
                                                <p class="card-text text-muted mb-0" style="font-size: 12px;">{{ factory.city.name }}, {{ factory.state.name }}</p>
                                            </div>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="text-muted text-center py-3 w-100">
                                        No factories found. Please ensure factories are created in the system.
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Selection Controls -->
                        <div class="mt-15">
                            <button type="button" id="select-all-factories" class="btn btn-outline-primary btn-sm me-2">
                                Select All
                            </button>
                            <button type="button" id="clear-all-factories" class="btn btn-outline-secondary btn-sm">
                                Clear All
                            </button>
                        </div>
                    </div>
                    </div>

                    <div class="line mt-20 mb-20"></div>

                    <div class="d-flex items-center mb-30">
                        <div class="form-checkbox">
                            {{ form.is_published }}
                        </div>
                        <div class="lh-16 ml-15">Save as Published</div>
                    </div>

                    <h2 class="text-24 fw-700 pt-40 mb-20">Post Gallery</h2>
                    <!-- <div class="upload-zone mb-20" onclick="document.getElementById('images-input').click()">
                        <i class="icon-upload text-30 mb-10"></i>
                        <p>Click to upload multiple images</p>
                        <input type="file" id="images-input" name="images" multiple accept="image/*" hidden>
                    </div> -->

                   <div id="image-preview-grid" class="d-flex flex-wrap gap-3 pt-20">
                        {% for image in object.images.all %}
                            <div class="position-relative shadow-sm rounded-3 overflow-hidden border" style="width: 20%; padding: 15px;;">
                                <div class="ratio ratio-1x1 bg-light">
                                    <img src="{{ image.image.url }}" 
                                        class="object-fit-cover" 
                                        style="width: 100%; height: 100%;" 
                                        alt="Existing Image">
                                </div>
                                
                                <div class="position-absolute bottom-0 start-0 w-100 bg-dark-transparent text-white text-center py-1" style="font-size: 10px;">
                                    #{{ forloop.counter }}
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted small">No images uploaded yet.</p>
                        {% endfor %}
                    </div>

                    <div class="row y-gap-15 justify-between items-center pt-40">
                        <div class="col-auto">
                            <button type="submit" class="button -md -dark-1 bg-accent-1 text-white">
                                Update Post <i class="icon-arrow-top-right text-16 ml-10"></i>
                            </button>
                        </div>
                        <div class="col-auto">
                            <a href="{% url 'blog:post_detail' slug=object.slug %}" class="text-muted">Cancel and go back</a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<div id="blog-form-container" 
     data-saved-category="{{ object.category.id|default:'' }}"
     data-saved-subcategory="{{ object.subcategory.id|default:'' }}"
     data-saved-country="{{ object.country.id|default:'' }}"
     data-saved-state="{{ object.state.id|default:'' }}"
     data-saved-city="{{ object.city.id|default:'' }}"
     data-saved-district="{{ object.district.id|default:'' }}"
     data-saved-region="{{ object.region.id|default:'' }}">
     
    </div>

{% endblock %}

{% block extra_css %}
<style>
/* 1. DIRECT COPIES FROM BLOG_DETAILS.HTML */
.bg-dark-transparent {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
}
.object-fit-cover {
    object-fit: cover;
}

.featured-hero-card {
  position: relative;
  width: 100%;
  height: 400px;
  overflow: hidden;
  background: #2c3e50;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

.hero-img { width: 100%; height: 100%; object-fit: cover; }
.hero-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.8) 100%);
}

.hero-content { position: absolute; bottom: 40px; left: 40px; z-index: 2; }

.badge-featured {
  background: #EB662B; /* Using your accent color */
  color: white;
  padding: 4px 12px;
  border-radius: 100px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
}

/* 2. FORM ELEMENTS REFINED TO FIT THE DESIGN */
.form-input { position: relative; width: 100%; }
.form-input input, .form-input textarea, select {
    width: 100%;
    padding: 15px;
    border: 1px solid #EAEAEA;
    border-radius: 8px;
    font-size: 16px;
}

.form-input label {
    position: absolute;
    top: -10px;
    left: 12px;
    background: white;
    padding: 0 5px;
    font-size: 12px;
    color: #EB662B;
    font-weight: 600;
}

.upload-zone {
    border: 2px dashed #EB662B;
    padding: 30px;
    text-align: center;
    border-radius: 12px;
    background: #FFF9F6;
    cursor: pointer;
}

/* Match the gallery images from details */
.gallery-preview-img {
    border-radius: 8px;
    width: 100%;
    height: 300px;
    object-fit: cover;
}

/* Form field styling improvements */
.form-group-custom {
    flex: 1;
    min-width: 200px;
}

.form-group-custom select {
    width: 100%;
    padding: 12px;
    border: 1px solid #EAEAEA;
    border-radius: 8px;
    font-size: 14px;
    background: white;
}

.form-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #EB662B;
    margin-right: 10px;
}

/* Error styling */
.form-input.error input, .form-input.error textarea, .form-input.error select {
    border-color: #dc3545;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

.form-error {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

/* Form field improvements */
.form-group-custom {
    margin-bottom: 15px;
}

/* Checkbox label styling */
.form-checkbox label {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    cursor: pointer;
    margin: 0;
}

/* Section spacing improvements */
.line {
    height: 1px;
    background: #EAEAEA;
    margin: 20px 0;
}

/* Better form layout */
.mb-30 {
    margin-bottom: 30px;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .form-group-custom {
        flex: 1 1 100%;
        min-width: 100%;
    }
    
    .d-flex.flex-wrap.align-items-center {
        flex-direction: column;
        align-items: stretch;
    }
    
    .d-flex.flex-wrap.align-items-center > .form-group-custom {
        margin-bottom: 15px;
    }
}

/* Factory Cards Styling */
.factory-cards-wrapper::-webkit-scrollbar {
    height: 8px;
}

.factory-cards-wrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.factory-cards-wrapper::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.factory-cards-wrapper::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Card hover effects */
.factory-card-item .card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.factory-card-item:hover .card {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Search highlighting */
.factory-card-item mark {
    background-color: #fff3cd;
    color: #856404;
    padding: 0 2px;
    border-radius: 3px;
    font-weight: 600;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Live Preview for Title
document.querySelector('input[name="title"]').addEventListener('input', function(e) {
    document.getElementById('title-live-preview').innerText = e.target.value || "Untitled Article";
});

// Gallery Preview matching your exact Detail Page layout
document.getElementById('images-input').addEventListener('change', function(e) {
    const grid = document.getElementById('image-preview-grid');
    grid.innerHTML = '';
    
    Array.from(this.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            // First image becomes hero preview
            if(index === 0) document.getElementById('hero-preview').src = event.target.result;
            
            const col = document.createElement('div');
            col.className = 'col-md-6';
            col.innerHTML = `
                <img src="${event.target.result}" class="gallery-preview-img">
                <div class="mt-10 text-14">Image Preview ${index + 1}</div>
            `;
            grid.appendChild(col);
        };
        reader.readAsDataURL(file);
    });
});

// Form validation
document.getElementById('blog-form').addEventListener('submit', function(e) {
    const title = document.querySelector('input[name="title"]').value.trim();
    const content = document.querySelector('textarea[name="content"]').value.trim();
    
    if (!title) {
        e.preventDefault();
        const titleInput = document.querySelector('input[name="title"]');
        titleInput.parentElement.classList.add('error');
        if (!titleInput.parentElement.querySelector('.form-error')) {
            const error = document.createElement('span');
            error.className = 'form-error';
            error.textContent = 'Title is required';
            titleInput.parentElement.appendChild(error);
        }
    }
    
    if (!content) {
        e.preventDefault();
        const contentInput = document.querySelector('textarea[name="content"]');
        contentInput.parentElement.classList.add('error');
        if (!contentInput.parentElement.querySelector('.form-error')) {
            const error = document.createElement('span');
            error.className = 'form-error';
            error.textContent = 'Content is required';
            contentInput.parentElement.appendChild(error);
        }
    }
});

// Clear error states on input
document.querySelectorAll('.form-input input, .form-input textarea').forEach(input => {
    input.addEventListener('input', function() {
        this.parentElement.classList.remove('error');
        const error = this.parentElement.querySelector('.form-error');
        if (error) error.remove();
    });
});

// Related Factories Search and Selection Functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('factory-search');
    const factoryCards = document.querySelectorAll('.factory-card-item');
    const selectAllBtn = document.getElementById('select-all-factories');
    const clearAllBtn = document.getElementById('clear-all-factories');

    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            factoryCards.forEach(item => {
                const factoryName = item.getAttribute('data-name');
                const checkbox = item.querySelector('input[type="checkbox"]');
                
                if (searchTerm === '' || factoryName.includes(searchTerm)) {
                    item.style.display = 'block';
                    // Highlight matching text in card title
                    if (searchTerm) {
                        const title = item.querySelector('.card-title');
                        const originalText = title.textContent;
                        const highlightedText = originalText.replace(
                            new RegExp(`(${searchTerm})`, 'gi'),
                            '<mark>$1</mark>'
                        );
                        title.innerHTML = highlightedText;
                    } else {
                        const title = item.querySelector('.card-title');
                        title.innerHTML = title.textContent;
                    }
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    // Select All functionality
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            factoryCards.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (item.style.display !== 'none') {
                    checkbox.checked = true;
                }
            });
        });
    }

    // Clear All functionality
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function() {
            factoryCards.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = false;
            });
        });
    }

    // Cascading Filter Logic for Categories and Locations
    const categorySelect = document.querySelector('select[name="category"]');
    const subcategorySelect = document.querySelector('select[name="subcategory"]');
    const countrySelect = document.querySelector('select[name="country"]');
    const stateSelect = document.querySelector('select[name="state"]');
    const citySelect = document.querySelector('select[name="city"]');
    const districtSelect = document.querySelector('select[name="district"]');
    const regionSelect = document.querySelector('select[name="region"]');

    // Category to Subcategory cascading
    if (categorySelect && subcategorySelect) {
        categorySelect.addEventListener('change', function() {
            const categoryId = this.value;
            if (categoryId) {
                // Enable subcategory dropdown
                subcategorySelect.disabled = false;
                
                // Clear current options except the first one
                const firstOption = subcategorySelect.options[0];
                subcategorySelect.innerHTML = '';
                subcategorySelect.appendChild(firstOption);
                
                // Fetch subcategories for selected category
                fetch(`/categories/ajax/load-subcategories/${categoryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.id;
                            option.textContent = subcategory.name;
                            subcategorySelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching subcategories:', error));
            } else {
                // Disable subcategory dropdown if no category selected
                subcategorySelect.disabled = true;
                subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            }
        });
    }

    // Country to State cascading
    if (countrySelect && stateSelect) {
        countrySelect.addEventListener('change', function() {
            const countryId = this.value;
            if (countryId) {
                stateSelect.disabled = false;
                const firstOption = stateSelect.options[0];
                stateSelect.innerHTML = '';
                stateSelect.appendChild(firstOption);
                
                fetch(`/location/ajax/states-by-country/${countryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state.id;
                            option.textContent = state.name;
                            stateSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching states:', error));
            } else {
                stateSelect.disabled = true;
                stateSelect.innerHTML = '<option value="">Select State</option>';
            }
        });
    }

    // State to City cascading
    if (stateSelect && citySelect) {
        stateSelect.addEventListener('change', function() {
            const stateId = this.value;
            if (stateId) {
                citySelect.disabled = false;
                const firstOption = citySelect.options[0];
                citySelect.innerHTML = '';
                citySelect.appendChild(firstOption);
                
                fetch(`/location/ajax/cities-by-state/${stateId}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.id;
                            option.textContent = city.name;
                            citySelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching cities:', error));
            } else {
                citySelect.disabled = true;
                citySelect.innerHTML = '<option value="">Select City</option>';
            }
        });
    }

    // City to District cascading
    if (citySelect && districtSelect) {
        citySelect.addEventListener('change', function() {
            const cityId = this.value;
            if (cityId) {
                districtSelect.disabled = false;
                const firstOption = districtSelect.options[0];
                districtSelect.innerHTML = '';
                districtSelect.appendChild(firstOption);
                
                fetch(`/location/ajax/districts-by-city/${cityId}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(district => {
                            const option = document.createElement('option');
                            option.value = district.id;
                            option.textContent = district.name;
                            districtSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching districts:', error));
            } else {
                districtSelect.disabled = true;
                districtSelect.innerHTML = '<option value="">Select District</option>';
            }
        });
    }

    // District to Region cascading
    if (districtSelect && regionSelect) {
        districtSelect.addEventListener('change', function() {
            const districtId = this.value;
            if (districtId) {
                regionSelect.disabled = false;
                const firstOption = regionSelect.options[0];
                regionSelect.innerHTML = '';
                regionSelect.appendChild(firstOption);
                
                fetch(`/location/ajax/regions-by-district/${districtId}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.id;
                            option.textContent = region.name;
                            regionSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching regions:', error));
            } else {
                regionSelect.disabled = true;
                regionSelect.innerHTML = '<option value="">Select Region</option>';
            }
        });
    }
});
</script>
{% endblock %}
